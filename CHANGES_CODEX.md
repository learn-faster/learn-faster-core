# Changes and Updates

**Summary**
This file captures the changes applied during the review and hardening pass, including backend fixes, frontend stability improvements, Vercel deployment readiness, and performance optimizations.

**Backend**
- Added `/health` endpoint and `/api/config` endpoint to support frontend health checks and runtime status. `main.py`
- Added graceful shutdown cleanup for LLM HTTP client. `main.py`
- Fixed image ingestion by adding OCR support and routing images through OCR in extraction. `src/services/ocr_service.py`, `src/routers/documents.py`
- Added basic non-PDF reading-time analysis to avoid PDF-only logic for text/image sources. `src/routers/documents.py`
- Fixed ingestion job lifecycle so retries create new jobs and text-missing failures update job and document state. `src/routers/documents.py`
- Debounced ingestion progress updates to reduce DB churn. `src/routers/documents.py`
- Replaced `print` statements with structured logging in ingestion flow. `src/routers/documents.py`
- Prevented path traversal on uploads with filename sanitization. `src/storage/document_store.py`
- Fixed `delete_chunks_by_concept` to return a real count. `src/ingestion/vector_storage.py`
- Added bounded concurrency for embedding generation in batch storage. `src/ingestion/vector_storage.py`
- Fixed `process_document_scoped*` chunk handling for tuples vs strings. `src/ingestion/ingestion_engine.py`
- Corrected `LLMConfig` import to avoid router dependency. `src/path_resolution/content_retriever.py`
- Optimized path resolution to avoid N+1 queries when checking completed concepts. `src/path_resolution/path_resolver.py`
- Fixed time tracking to handle nulls safely. `src/services/time_tracking_service.py`
- Guarded web metadata extraction for `None` metadata. `src/services/web_extractor.py`
- Improved analytics time-range filtering and velocity calculation. `src/routers/analytics.py`
- Fixed `DocumentProcessor` usage in AI routes (tuple unpacking and threadpool for blocking work). `src/routers/ai.py`
- Offloaded blocking extraction steps to threadpool. `src/routers/documents.py`
- Added embedding settings persistence and runtime sync (provider/model/api/base_url), plus embedding health endpoint. `src/models/orm.py`, `src/database/init_db.py`, `database/init.sql`, `main.py`, `src/routers/cognitive.py`
- Added migrations for embedding settings and ingestion job FK cascade. `src/database/migrations/add_embedding_settings_columns.py`, `src/database/migrations/alter_ingestion_jobs_fk.py`
- Added document deletion cleanup for dependent tables before delete. `src/storage/document_store.py`
- Guarded OCR fallback to PDFs only and improved ingestion job tracking. `src/routers/documents.py`, `src/ingestion/ingestion_engine.py`
- Made embedding concurrency configurable. `src/config.py`, `src/ingestion/vector_storage.py`
- Added schema nudge for multi-document graph labels/relationships to avoid Neo4j warnings. `src/database/graph_storage.py`
- Improved LLM error messaging and provider base_url selection for extraction. `src/services/llm_service.py`, `src/ingestion/ingestion_engine.py`
- Improved ingestion error surfacing and job progress fallback on `/documents`. `src/routers/documents.py`
- Refined job progress syncing so `/documents` progress doesn't stick at 10%. `src/routers/documents.py`
- Added document delete guard when linked to knowledge graphs (409) with optional `remove_graph_links` parameter. `src/routers/documents.py`
- Made ingestion job updates resilient if the job row is deleted mid-process. `src/routers/documents.py`
- Added knowledge-graph link metadata on document responses for UI indicators. `src/routers/documents.py`, `src/models/schemas.py`
- Added mocked Fitbit integration tests for biometrics normalization, readiness scoring, and summary formatting. `tests/test_fitbit_integration.py`
- Fixed Fitbit model import to avoid circular import on service load. `src/models/fitbit.py`
- Added Fitbit router tests and agent biometrics prompt test. `tests/test_fitbit_routes.py`, `tests/test_fitbit_agent_usage.py`
- Added frontend Fitibit UI tests with Vitest + RTL setup. `frontend/src/test/agent-settings-fitbit.test.jsx`, `frontend/src/test/setup.js`, `frontend/package.json`, `frontend/vite.config.js`
- Fixed modal manager hook bug and stabilized related frontend tests. `frontend/src/lib/hooks/use-modal-manager.js`, `frontend/src/modules/open-notebook/lib/hooks/use-modal-manager.js`, `frontend/src/lib/hooks/use-modal-manager.test.js`, `frontend/src/modules/open-notebook/lib/hooks/use-modal-manager.test.js`
- Fixed stray TS syntax in podcast dialog and stabilized AppSidebar tests. `frontend/src/components/podcasts/GeneratePodcastDialog.jsx`, `frontend/src/components/layout/AppSidebar.test.jsx`
- Added vitest test setup mocks and next/navigation stub to keep frontend tests deterministic. `frontend/src/test/setup.js`, `frontend/src/test/next-navigation-mock.js`, `frontend/vite.config.js`
- Added Fitbit demo mode support in agent settings and API responses. `src/models/agent.py`, `src/routers/goals.py`, `src/routers/fitbit.py`, `src/services/goal_agent.py`, `frontend/src/components/GoalAgent/AgentSettings.jsx`
- Added Neo4j compatibility shim for legacy imports. `src/database/neo4j_conn.py`
- Added Fitbit demo mode tests. `tests/test_fitbit_routes.py`, `tests/test_fitbit_agent_usage.py`
- Reduced test warnings (pydantic config, ffmpeg warning filter, timezone-safe timestamps). `src/models/schemas.py`, `pytest.ini`, `tests/test_fitbit_*.py`, `src/services/fitbit_service.py`, `frontend/src/test/setup.js`
- Unified concept extraction truncation limit via `EXTRACTION_MAX_CHARS` and applied to LLM extraction + ingestion windowing. `src/config.py`, `.env.example`, `src/services/llm_service.py`, `src/ingestion/ingestion_engine.py`
- Updated ingestion progress callback to use short-lived DB sessions and keep job progress in sync. `src/routers/documents.py`
- Added Redis + RQ ingestion queue with worker script, plus optional enqueue for extraction/ingestion (fallback to BackgroundTasks if Redis unavailable). `src/queue/ingestion_queue.py`, `src/tasks/ingestion_tasks.py`, `scripts/rq_worker.py`, `src/config.py`, `.env.example`, `src/routers/documents.py`, `pyproject.toml`
- Replaced remaining LLM JSON parsing sites with robust `_extract_and_parse_json`. `src/services/goal_agent.py`, `src/services/concept_tutor.py`, `src/path_resolution/content_retriever.py`, `src/routers/curriculum.py`, `src/routers/multidoc_graph.py`, `src/routers/documents.py`
- Added knowledge graph build error persistence and extraction overrides (chunk size + max window chars). `src/models/orm.py`, `src/models/schemas.py`, `src/database/init_db.py`, `src/routers/multidoc_graph.py`, `src/ingestion/ingestion_engine.py`
- Improved LLM error messaging for oversized requests (413/TPM) with actionable guidance. `src/services/llm_service.py`

**Frontend**
- Downgraded `date-fns` to v2 to resolve missing locale file errors in Vite. `frontend/package.json`, `frontend/package-lock.json`
- Replaced `process.env.NODE_ENV` with `import.meta.env.DEV` for Vite compatibility. `frontend/src/components/common/ErrorBoundary.jsx`
- Added retry/backoff with jitter for config fetches. `frontend/src/lib/config.js`, `frontend/src/modules/open-notebook/lib/config.js`
- Added `/health` check before `/api/config` in connection guard. `frontend/src/components/common/ConnectionGuard.jsx`, `frontend/src/lib/config.js`
- Added optional “Continue anyway” path and a non-blocking banner when API is down. `frontend/src/components/common/ConnectionGuard.jsx`, `frontend/src/components/errors/ConnectionErrorOverlay.jsx`
- Improved attempted URL reporting for config errors. `frontend/src/lib/config.js`, `frontend/src/modules/open-notebook/lib/config.js`
- Updated frontend README for local dev and Vercel deployment guidance. `frontend/README.md`
- Added `frontend/vercel.json` for SPA routing on Vercel. `frontend/vercel.json`
- Added `frontend/.env.example` for `VITE_API_URL`. `frontend/.env.example`
- Added centralized API error formatting with toast support. `frontend/src/lib/utils/api-error.js`, `frontend/src/services/api.js`, `frontend/src/lib/api/client.js`
- Surface document ingestion errors and embedding connection status in Documents UI. `frontend/src/pages/Documents.jsx`
- Added embedding health check and settings persistence hooks. `frontend/src/pages/Documents.jsx`, `frontend/src/services/cognitive.js`
- Added document synthesize/reprocess error handling and optimistic status updates. `frontend/src/stores/useDocumentStore.js`, `frontend/src/pages/Documents.jsx`
- Added processing status banner and ingestion error display in Document Viewer. `frontend/src/pages/DocumentViewer.jsx`
- Updated Knowledge Graph background to stronger space theme. `frontend/src/pages/KnowledgeGraph.jsx`
- Added Knowledge Graph error toasts and inline error banner. `frontend/src/pages/KnowledgeGraph.jsx`
- Added ingest action button to document cards for quick graph rebuilds. `frontend/src/pages/Documents.jsx`
- Settings drawer now loads/saves global LLM config via backend and shows load/save errors. `frontend/src/components/Settings.jsx`
- Added LLM health endpoint and frontend connection status panel (backend + LLM). `src/routers/cognitive.py`, `frontend/src/components/Settings.jsx`, `frontend/src/services/cognitive.js`
- Improved global API error formatting with concise, actionable messages. `frontend/src/lib/utils/api-error.js`
- Added inline error banners for top pages (Dashboard, Documents, Settings). `frontend/src/pages/Dashboard.jsx`, `frontend/src/pages/Documents.jsx`, `frontend/src/pages/Settings.jsx`
- Added inline error banners for Practice, Analytics, and Curriculum pages. `frontend/src/pages/Practice.jsx`, `frontend/src/pages/Analytics.jsx`, `frontend/src/pages/CurriculumList.jsx`, `frontend/src/pages/CurriculumView.jsx`
- Added reusable InlineErrorBanner component and applied it across pages, plus AdminEmails/DailyGoals error banners. `frontend/src/components/common/InlineErrorBanner.jsx`, `frontend/src/pages/Dashboard.jsx`, `frontend/src/pages/Documents.jsx`, `frontend/src/pages/Settings.jsx`, `frontend/src/pages/Practice.jsx`, `frontend/src/pages/Analytics.jsx`, `frontend/src/pages/CurriculumList.jsx`, `frontend/src/pages/CurriculumView.jsx`, `frontend/src/pages/AdminEmails.jsx`, `frontend/src/pages/DailyGoals.jsx`
- Redesigned Goal Agent welcome overlay with space theme, spaceship animation, and center chat input; Skip now persists across refreshes. `frontend/src/components/GoalAgent/AgentWelcome.jsx`, `frontend/src/components/GoalAgent/AgentDock.jsx`
- Added delete confirmation modal with graph-link choice and API param support. `frontend/src/pages/Documents.jsx`, `frontend/src/stores/useDocumentStore.js`
- Added “Graph linked” indicator on document cards. `frontend/src/pages/Documents.jsx`
- Fixed dev backend URL detection to default to `http://localhost:8001` unless explicitly overridden. `frontend/src/lib/config.js`
- Hardened PDF rendering against cMap URL errors and added a PDF error boundary to prevent black screens. `frontend/src/pages/DocumentViewer.jsx`
- Added local PDF.js assets copy (cmaps + standard fonts) and wired viewer to `/pdfjs/` assets. `frontend/scripts/copy-pdfjs-assets.js`, `frontend/package.json`, `frontend/src/pages/DocumentViewer.jsx`
- Added queued/running status badge on document cards using ingestion phase. `frontend/src/pages/Documents.jsx`
- Added queue connectivity status to `/api/config` and surfaced tiny Queue status indicator in Documents UI. `main.py`, `frontend/src/lib/config.js`, `frontend/src/pages/Documents.jsx`
- Updated Open Notebook config detection to use backend URL defaults (fixes calls going to `:5173`). `frontend/src/modules/open-notebook/lib/config.js`
- Normalized SurrealDB record IDs in chat API clients to avoid `[object Object]` session IDs and 422s on `/chat/execute`. `frontend/src/modules/open-notebook/lib/api/chat.js`, `frontend/src/lib/api/chat.js`
- Guarded SessionManager date formatting against invalid timestamps. `frontend/src/components/source/SessionManager.jsx`
- Added CORS fallback for local dev if computed origins are empty. `main.py`
- Created ingestion jobs at enqueue time (so queued status + errors show immediately) and re-used jobs when processing starts. `src/routers/documents.py`
- Added a queued hint banner in Documents when progress stays at 0%. `frontend/src/pages/Documents.jsx`
- Prevented Knowledge Graph guide modal from reappearing once dismissed (persisted in localStorage). `frontend/src/pages/KnowledgeGraph.jsx`
- Added API key field to knowledge graph LLM settings in the create/edit modal. `frontend/src/pages/KnowledgeGraph.jsx`
- Added show/hide toggle for knowledge graph API key input. `frontend/src/pages/KnowledgeGraph.jsx`
- Throttled document polling in Documents and Knowledge Graph, and skipped polling when tab is hidden. `frontend/src/pages/Documents.jsx`, `frontend/src/pages/KnowledgeGraph.jsx`, `frontend/src/stores/useDocumentStore.js`
- Added Knowledge Graph build controls for extraction window and chunk size, plus inline error display for failed builds. `frontend/src/pages/KnowledgeGraph.jsx`
- Added Knowledge Graph build progress tracking and UI progress indicator. `src/models/orm.py`, `src/models/schemas.py`, `src/database/init_db.py`, `src/routers/multidoc_graph.py`, `frontend/src/pages/KnowledgeGraph.jsx`

**Additional Notes**
- Frontend now assumes `VITE_API_URL` for production and keeps local dev working with proxy or explicit env.
- Backend `/api/config` currently reports Postgres health only.
